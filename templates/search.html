{% extends "base.html" %}

{% block title %}搜索结果{% if query %} - {{ query }}{% endif %}{% endblock %}

{% block content %}
<div class="mb-4">
    {% if query %}
        <h1><i class="bi bi-search"></i> 搜索结果</h1>
        <p class="text-muted">关键词："{{ query }}"，找到 {{ posts.total }} 个结果</p>
    {% else %}
        <h1><i class="bi bi-search"></i> 搜索文章</h1>
        <p class="text-muted">请输入搜索关键词</p>
    {% endif %}
</div>

<!-- 搜索框 -->
<div class="card mb-4">
    <div class="card-body">
        <form action="/search" method="GET">
            <div class="input-group">
                <input type="text" class="form-control" name="q" 
                       placeholder="输入关键词搜索文章标题和内容..." 
                       value="{{ query }}" autofocus>
                <button class="btn btn-primary" type="submit">
                    <i class="bi bi-search"></i> 搜索
                </button>
            </div>
        </form>
    </div>
</div>

<!-- 在搜索页面添加客户端搜索功能 -->
<script>
let allPosts = [];

// 加载所有文章数据用于搜索
async function loadAllPosts() {
    try {
        const response = await fetch('./api/search/all.json');
        const result = await response.json();
        if (result.success) {
            allPosts = result.posts;
        }
    } catch (error) {
        console.error('加载文章数据失败:', error);
    }
}

// 客户端搜索函数
function performSearch(query) {
    if (!query.trim()) {
        displaySearchResults([]);
        return;
    }
    
    const results = allPosts.filter(post => 
        post.title.toLowerCase().includes(query.toLowerCase()) ||
        post.content.toLowerCase().includes(query.toLowerCase())
    );
    
    displaySearchResults(results);
}

// 显示搜索结果
function displaySearchResults(posts) {
    const container = document.getElementById('search-results');
    container.innerHTML = '';
    
    if (posts.length === 0) {
        container.innerHTML = '<p class="text-center text-muted">没有找到相关文章</p>';
        return;
    }
    
    posts.forEach(post => {
        const postElement = document.createElement('div');
        postElement.className = 'col-md-6 col-lg-4 mb-4';
        postElement.innerHTML = `
            <div class="card post-card h-100">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">
                        <a href="./post/${post.id}.html" class="text-decoration-none">${post.title}</a>
                    </h5>
                    <p class="card-text flex-grow-1">${post.summary || post.content.substring(0, 150) + '...'}</p>
                </div>
            </div>
        `;
        container.appendChild(postElement);
    });
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    loadAllPosts();
    
    // 绑定搜索事件
    const searchInput = document.querySelector('input[name="q"]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            performSearch(this.value);
        });
        
        // 如果URL中有查询参数，执行搜索
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');
        if (query) {
            searchInput.value = query;
            performSearch(query);
        }
    }
});
</script>
{% if posts.posts %}
    <div class="row">
        {% for post in posts.posts %}
        <div class="col-12 mb-3">
            <div class="card post-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <a href="/post/{{ post.id }}" class="text-decoration-none">{{ post.title }}</a>
                    </h5>
                    <p class="card-text text-muted">{{ post.summary or post.content[:200] + '...' }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- 分页 -->
    {% if posts.pages > 1 %}
    <nav aria-label="搜索结果分页">
        <ul class="pagination justify-content-center">
            {% if posts.page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('search', q=query, page=posts.page-1) }}">
                        <i class="bi bi-chevron-left"></i> 上一页
                    </a>
                </li>
            {% endif %}
            
            {% for page_num in range(1, posts.pages + 1) %}
                {% if page_num != posts.page %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('search', q=query, page=page_num) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if posts.page < posts.pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('search', q=query, page=posts.page+1) }}">
                        下一页 <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
{% else %}
    {% if query %}
    <div class="text-center mt-5">
        <i class="bi bi-search" style="font-size: 3rem; color: #6c757d;"></i>
        <h3 class="mt-3 text-muted">未找到相关文章</h3>
        <p class="text-muted">请尝试其他关键词或检查拼写</p>
    </div>
    {% endif %}
{% endif %}
{% endblock %}